<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Kristjan Hočevar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #1A1612; --surface: #241F1A; --primary: #2C4A3E;
      --secondary: #6B8F71; --accent: #C8953C; --text: #F2EAE0;
      --muted: #A89B8C; --danger: #c0392b;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .hidden { display: none !important; }

    /* Login */
    #login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .login-box { background: var(--surface); padding: 2.5rem; border-radius: 4px; width: 100%; max-width: 380px; border: 1px solid rgba(242,234,224,0.1); }
    .login-box h1 { font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
    .login-box input { width: 100%; padding: 0.75rem 1rem; background: var(--bg); border: 1px solid rgba(242,234,224,0.15); border-radius: 4px; color: var(--text); font-size: 0.95rem; margin-bottom: 1rem; outline: none; }
    .login-box input:focus { border-color: var(--accent); }
    .login-box button { width: 100%; padding: 0.75rem; background: var(--accent); color: var(--bg); border: none; border-radius: 4px; font-weight: 600; font-size: 0.95rem; cursor: pointer; }
    .login-box button:hover { opacity: 0.9; }
    .login-error { color: var(--danger); font-size: 0.85rem; margin-top: 0.5rem; text-align: center; }

    /* Layout */
    #app { display: flex; min-height: 100vh; }
    #sidebar { width: 240px; background: var(--surface); border-right: 1px solid rgba(242,234,224,0.08); padding: 1.5rem 0; flex-shrink: 0; position: fixed; top: 0; bottom: 0; overflow-y: auto; }
    #sidebar h2 { font-size: 0.85rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent); padding: 0 1.25rem; margin-bottom: 1.5rem; }
    .nav-item { display: block; padding: 0.65rem 1.25rem; color: var(--muted); cursor: pointer; font-size: 0.9rem; transition: all 0.2s; border-left: 3px solid transparent; }
    .nav-item:hover { color: var(--text); background: rgba(242,234,224,0.03); }
    .nav-item.active { color: var(--accent); border-left-color: var(--accent); background: rgba(200,149,60,0.05); }
    #sidebar .logout { margin-top: 2rem; padding: 0 1.25rem; }
    #sidebar .logout button { width: 100%; padding: 0.5rem; background: transparent; border: 1px solid rgba(242,234,224,0.15); color: var(--muted); border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
    #sidebar .logout button:hover { border-color: var(--danger); color: var(--danger); }

    #main { flex: 1; margin-left: 240px; padding: 2rem 2.5rem; max-width: 900px; }
    #main h2 { font-size: 1.5rem; margin-bottom: 1.5rem; }

    /* Forms */
    .field { margin-bottom: 1.25rem; }
    .field label { display: block; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 0.4rem; }
    .field input, .field textarea, .field select { width: 100%; padding: 0.6rem 0.8rem; background: var(--bg); border: 1px solid rgba(242,234,224,0.12); border-radius: 4px; color: var(--text); font-size: 0.9rem; font-family: inherit; outline: none; }
    .field input:focus, .field textarea:focus { border-color: var(--accent); }
    .field textarea { min-height: 80px; resize: vertical; }

    .btn { padding: 0.6rem 1.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; transition: opacity 0.2s; }
    .btn-primary { background: var(--accent); color: var(--bg); }
    .btn-secondary { background: transparent; border: 1px solid rgba(242,234,224,0.2); color: var(--text); }
    .btn-danger { background: var(--danger); color: white; }
    .btn:hover { opacity: 0.85; }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

    .actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; align-items: center; }
    .save-status { font-size: 0.85rem; color: var(--secondary); }

    /* Cards */
    .card { background: var(--surface); border: 1px solid rgba(242,234,224,0.08); border-radius: 4px; padding: 1.25rem; margin-bottom: 1rem; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .card-header h3 { font-size: 1rem; }

    .img-preview { max-width: 200px; max-height: 120px; border-radius: 4px; margin-top: 0.4rem; object-fit: cover; }
    .img-row { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.4rem; }
    .img-row img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid rgba(242,234,224,0.1); }

    /* Toast */
    #toast { position: fixed; bottom: 2rem; right: 2rem; padding: 0.75rem 1.25rem; border-radius: 4px; font-size: 0.9rem; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.success { background: var(--primary); color: var(--text); }
    #toast.error { background: var(--danger); color: white; }

    .loading { text-align: center; padding: 3rem; color: var(--muted); }

    @media (max-width: 768px) {
      #sidebar { width: 100%; position: static; border-right: none; border-bottom: 1px solid rgba(242,234,224,0.08); padding: 1rem 0; }
      #app { flex-direction: column; }
      #main { margin-left: 0; padding: 1.5rem; }
      .nav-item { display: inline-block; border-left: none; border-bottom: 3px solid transparent; }
      .nav-item.active { border-bottom-color: var(--accent); border-left-color: transparent; }
    }
  </style>
</head>
<body>

<!-- Login -->
<div id="login-screen">
  <div class="login-box">
    <h1>Admin Panel</h1>
    <input type="password" id="login-password" placeholder="Geslo" autocomplete="current-password" />
    <button onclick="doLogin()">Prijava</button>
    <div id="login-error" class="login-error hidden"></div>
  </div>
</div>

<!-- App -->
<div id="app" class="hidden">
  <nav id="sidebar">
    <h2>Admin</h2>
    <div class="nav-item active" data-section="hero">Hero</div>
    <div class="nav-item" data-section="about">O meni</div>
    <div class="nav-item" data-section="ponudba">Ponudba</div>
    <div class="nav-item" data-section="videos">Videospoti</div>
    <div class="nav-item" data-section="gallery">Galerija</div>
    <div class="nav-item" data-section="news">Novice</div>
    <div class="nav-item" data-section="contact">Kontakt</div>
    <div class="logout"><button onclick="doLogout()">Odjava</button></div>
  </nav>

  <main id="main">
    <div class="loading">Nalagam...</div>
  </main>
</div>

<div id="toast"></div>

<script>
const API_BASE = '/api';
const CLOUDINARY_CLOUD = 'dewf3zos0';
const CLOUDINARY_PRESETS = {
  gallery: 'kristjan_galerija',
  news: 'kristjan_novice',
  default: 'kristjan_galerija'
};
let token = sessionStorage.getItem('admin_token');
let currentSection = 'hero';
let sectionData = {};
let sectionSha = {};

// --- Auth ---
async function doLogin() {
  const pw = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.classList.add('hidden');
  try {
    const r = await fetch(API_BASE + '/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw })
    });
    const d = await r.json();
    if (!r.ok) { errEl.textContent = d.error || 'Napaka'; errEl.classList.remove('hidden'); return; }
    token = d.token;
    sessionStorage.setItem('admin_token', token);
    showApp();
  } catch(e) { errEl.textContent = 'Napaka pri povezavi'; errEl.classList.remove('hidden'); }
}

function doLogout() {
  sessionStorage.removeItem('admin_token');
  token = null;
  document.getElementById('app').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
}

document.getElementById('login-password').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doLogin();
});

// --- API ---
async function apiGet(file) {
  var r;
  try {
    r = await fetch(API_BASE + '/content?file=' + file, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
  } catch(e) {
    showToast('Napaka pri povezavi s strežnikom: ' + e.message, 'error');
    throw e;
  }
  if (r.status === 401) {
    var errMsg = 'Seja je potekla.';
    try { var d = await r.json(); errMsg = d.error || errMsg; } catch(e) {}
    showToast(errMsg, 'error');
    doLogout();
    return null;
  }
  if (!r.ok) {
    var errText = 'Napaka pri branju (HTTP ' + r.status + ')';
    try { var d = await r.json(); errText = d.error || errText; } catch(e) {}
    throw new Error(errText);
  }
  return r.json();
}

async function apiPut(file, content, sha) {
  var r;
  try {
    r = await fetch(API_BASE + '/content', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ file, content, sha })
    });
  } catch(e) {
    showToast('Napaka pri povezavi s strežnikom: ' + e.message, 'error');
    throw e;
  }
  if (r.status === 401) {
    var errMsg = 'Seja je potekla.';
    try { var d = await r.json(); errMsg = d.error || errMsg; } catch(e) {}
    showToast(errMsg, 'error');
    doLogout();
    return null;
  }
  var d = await r.json();
  if (!r.ok) throw new Error(d.error || 'Napaka pri shranjevanju');
  return d;
}

// --- Toast ---
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type + ' show';
  setTimeout(() => t.classList.remove('show'), 3000);
}

// --- Cloudinary Upload ---
function uploadImage(callback, preset) {
  var uploadPreset = preset || CLOUDINARY_PRESETS.default;
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = async function() {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { showToast('Datoteka prevelika (max 10MB)', 'error'); return; }
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', uploadPreset);
    try {
      showToast('Nalagam sliko...', 'success');
      const r = await fetch('https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/image/upload', { method: 'POST', body: fd });
      const d = await r.json();
      if (d.secure_url) { callback(d.secure_url); showToast('Slika naložena!', 'success'); }
      else { showToast('Napaka pri nalaganju', 'error'); }
    } catch(e) { showToast('Napaka pri nalaganju', 'error'); }
  };
  input.click();
}

// --- App Init ---
function showApp() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  loadSection(currentSection);
}

// --- Navigation ---
document.querySelectorAll('.nav-item').forEach(function(el) {
  el.addEventListener('click', function() {
    document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
    el.classList.add('active');
    currentSection = el.dataset.section;
    loadSection(currentSection);
  });
});

// --- Load Section ---
async function loadSection(section) {
  var main = document.getElementById('main');
  main.innerHTML = '<div class="loading">Nalagam...</div>';
  try {
    var result = await apiGet(section);
    if (!result) return;
    sectionData[section] = result.content;
    sectionSha[section] = result.sha;
    renderSection(section);
  } catch(e) {
    console.error('Napaka pri nalaganju sekcije "' + section + '":', e);
    main.innerHTML = '<div class="loading" style="color:var(--danger)">Napaka: ' + esc(e.message) + '<br><small style="color:var(--muted)">Preverite konzolo brskalnika za podrobnosti (F12).</small></div>';
  }
}

// --- Save ---
async function saveSection(section) {
  try {
    const data = collectFormData(section);
    const result = await apiPut(section, data, sectionSha[section]);
    if (result) {
      sectionSha[section] = result.sha;
      sectionData[section] = data;
      showToast('Shranjeno! Stran se bo posodobila v ~30s.', 'success');
    }
  } catch(e) {
    showToast(e.message, 'error');
  }
}

// --- Render Sections ---
function renderSection(section) {
  const main = document.getElementById('main');
  const data = sectionData[section];
  switch(section) {
    case 'hero': renderHero(main, data); break;
    case 'about': renderAbout(main, data); break;
    case 'ponudba': renderPonudba(main, data); break;
    case 'videos': renderVideos(main, data); break;
    case 'gallery': renderGallery(main, data); break;
    case 'news': renderNews(main, data); break;
    case 'contact': renderContact(main, data); break;
  }
}

function renderHero(el, d) {
  el.innerHTML = '<h2>Hero</h2>' +
    field('Naslov', 'text', 'hero-title', d.title) +
    field('Podnaslov', 'text', 'hero-subtitle', d.subtitle) +
    field('Podnapis', 'text', 'hero-tagline', d.tagline) +
    field('Slika URL', 'text', 'hero-image', d.image) +
    '<img class="img-preview" src="' + esc(d.image) + '" id="hero-image-preview" />' +
    '<button class="btn btn-secondary btn-sm" style="margin-top:0.5rem" onclick="uploadImage(function(url){document.getElementById(\'hero-image\').value=url;document.getElementById(\'hero-image-preview\').src=url;})">Naloži sliko</button>' +
    field('Alt tekst slike', 'text', 'hero-imageAlt', d.imageAlt) +
    '<h3 style="margin-top:1rem;margin-bottom:0.5rem">Gumbi</h3>' +
    d.buttons.map(function(b, i) {
      return '<div class="card"><div class="field"><label>Tekst gumba ' + (i+1) + '</label><input data-btn-text="' + i + '" value="' + esc(b.text) + '" /></div>' +
        '<div class="field"><label>Link</label><input data-btn-link="' + i + '" value="' + esc(b.link) + '" /></div></div>';
    }).join('') +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'hero\')">Shrani</button></div>';
}

function renderAbout(el, d) {
  el.innerHTML = '<h2>O meni</h2>' +
    field('Oznaka sekcije', 'text', 'about-sectionLabel', d.sectionLabel) +
    field('Naslov (besede, ločene z vejico)', 'text', 'about-title', d.title.join(', ')) +
    field('Slika URL', 'text', 'about-image', d.image) +
    '<img class="img-preview" src="' + esc(d.image) + '" id="about-image-preview" />' +
    '<button class="btn btn-secondary btn-sm" style="margin-top:0.5rem" onclick="uploadImage(function(url){document.getElementById(\'about-image\').value=url;document.getElementById(\'about-image-preview\').src=url;})">Naloži sliko</button>' +
    field('Alt tekst slike', 'text', 'about-imageAlt', d.imageAlt) +
    d.paragraphs.map(function(p, i) {
      return '<div class="field"><label>Odstavek ' + (i+1) + '</label><textarea data-para="' + i + '">' + esc(p) + '</textarea></div>';
    }).join('') +
    '<button class="btn btn-secondary btn-sm" onclick="addParagraph()">+ Dodaj odstavek</button>' +
    field('CTA tekst', 'text', 'about-ctaText', d.ctaText) +
    field('CTA link', 'text', 'about-ctaLink', d.ctaLink) +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'about\')">Shrani</button></div>';
}

function addParagraph() {
  sectionData['about'].paragraphs.push('');
  renderSection('about');
}

function renderPonudba(el, d) {
  el.innerHTML = '<h2>Ponudba</h2>' +
    field('Oznaka sekcije', 'text', 'ponudba-sectionLabel', d.sectionLabel) +
    field('Naslov (besede, ločene z vejico)', 'text', 'ponudba-title', d.title.join(', ')) +
    '<h3 style="margin-top:1rem;margin-bottom:0.5rem">Odstavki</h3>' +
    d.paragraphs.map(function(p, i) {
      return '<div class="field"><label>Odstavek ' + (i+1) + '</label><textarea data-ponudba-para="' + i + '">' + esc(p) + '</textarea></div>';
    }).join('') +
    '<button class="btn btn-secondary btn-sm" onclick="addPonudbaParagraph()">+ Dodaj odstavek</button>' +
    '<h3 style="margin-top:1.5rem;margin-bottom:0.5rem">Slika</h3>' +
    field('Slika URL', 'text', 'ponudba-image', d.image) +
    (d.image ? '<img class="img-preview" src="' + esc(d.image) + '" id="ponudba-image-preview" />' : '<img class="img-preview" id="ponudba-image-preview" style="display:none" />') +
    '<button class="btn btn-secondary btn-sm" style="margin-top:0.5rem" onclick="uploadImage(function(url){document.getElementById(\'ponudba-image\').value=url;var prev=document.getElementById(\'ponudba-image-preview\');prev.src=url;prev.style.display=\'block\';})">Naloži sliko</button>' +
    field('Alt tekst slike', 'text', 'ponudba-imageAlt', d.imageAlt) +
    field('CTA tekst', 'text', 'ponudba-ctaText', d.ctaText) +
    field('CTA link', 'text', 'ponudba-ctaLink', d.ctaLink) +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'ponudba\')">Shrani</button></div>';
}

function addPonudbaParagraph() {
  sectionData['ponudba'].paragraphs.push('');
  renderSection('ponudba');
}

function renderVideos(el, d) {
  el.innerHTML = '<h2>Videospoti</h2>' +
    field('Oznaka sekcije', 'text', 'videos-sectionLabel', d.sectionLabel) +
    field('Naslov (besede, ločene z vejico)', 'text', 'videos-title', d.title.join(', ')) +
    '<h3 style="margin-top:1rem;margin-bottom:0.5rem">Videi</h3>' +
    d.videos.map(function(v, i) {
      return '<div class="card"><div class="card-header"><h3>Video ' + (i+1) + '</h3><button class="btn btn-danger btn-sm" onclick="removeVideo(' + i + ')">Odstrani</button></div>' +
        '<div class="field"><label>YouTube ID</label><input data-vid-id="' + i + '" value="' + esc(v.id) + '" /></div>' +
        '<div class="field"><label>Naslov</label><input data-vid-title="' + i + '" value="' + esc(v.title) + '" /></div></div>';
    }).join('') +
    '<button class="btn btn-secondary btn-sm" onclick="addVideo()">+ Dodaj video</button>' +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'videos\')">Shrani</button></div>';
}

function addVideo() { sectionData['videos'].videos.push({id:'',title:''}); renderSection('videos'); }
function removeVideo(i) { sectionData['videos'].videos.splice(i,1); renderSection('videos'); }

function renderGallery(el, d) {
  el.innerHTML = '<h2>Galerija</h2>' +
    '<div id="gallery-items">' +
    d.images.map(function(img, i) {
      return '<div class="card"><div class="card-header"><h3>Slika ' + (i+1) + '</h3><button class="btn btn-danger btn-sm" onclick="removeGalleryImage(' + i + ')">Odstrani</button></div>' +
        '<img class="img-preview" src="' + esc(img.src) + '" />' +
        '<div class="field"><label>URL</label><input data-gal-src="' + i + '" value="' + esc(img.src) + '" /></div>' +
        '<div class="field"><label>Alt</label><input data-gal-alt="' + i + '" value="' + esc(img.alt) + '" /></div></div>';
    }).join('') +
    '</div>' +
    '<button class="btn btn-secondary btn-sm" onclick="addGalleryImage()">+ Dodaj sliko</button> ' +
    '<button class="btn btn-secondary btn-sm" onclick="uploadGalleryImage()">+ Naloži sliko</button>' +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'gallery\')">Shrani</button></div>';
}

function addGalleryImage() { sectionData['gallery'].images.push({src:'',alt:'Kristjan Hočevar nastop'}); renderSection('gallery'); }
function removeGalleryImage(i) { sectionData['gallery'].images.splice(i,1); renderSection('gallery'); }
function uploadGalleryImage() {
  uploadImage(function(url) {
    sectionData['gallery'].images.push({src:url, alt:'Kristjan Hočevar nastop'});
    renderSection('gallery');
  }, CLOUDINARY_PRESETS.gallery);
}

function renderNews(el, d) {
  el.innerHTML = '<h2>Novice</h2>' +
    d.items.map(function(item, i) {
      return '<div class="card"><div class="card-header"><h3>' + esc(item.title || 'Nova novica') + '</h3><button class="btn btn-danger btn-sm" onclick="removeNewsItem(' + i + ')">Odstrani</button></div>' +
        '<div class="field"><label>ID (slug)</label><input data-news-id="' + i + '" value="' + esc(item.id) + '" /></div>' +
        '<div class="field"><label>Datum</label><input type="date" data-news-date="' + i + '" value="' + esc(item.date) + '" /></div>' +
        '<div class="field"><label>Naslov</label><input data-news-title="' + i + '" value="' + esc(item.title) + '" /></div>' +
        '<div class="field"><label>Kratek opis</label><textarea data-news-desc="' + i + '">' + esc(item.description) + '</textarea></div>' +
        '<div class="field"><label>Celotno besedilo (opcijsko)</label><textarea data-news-fulltext="' + i + '">' + esc(item.fullText || '') + '</textarea></div>' +
        '<div class="field"><label>Tip</label><select data-news-type="' + i + '"><option value="novica"' + (item.type==='novica'?' selected':'') + '>Novica</option><option value="nastop"' + (item.type==='nastop'?' selected':'') + '>Nastop</option></select></div>' +
        '<div class="field"><label>Thumbnail URL</label><input data-news-thumb="' + i + '" value="' + esc(item.thumbnail) + '" /></div>' +
        (item.thumbnail ? '<img class="img-preview" src="' + esc(item.thumbnail) + '" />' : '') +
        '<button class="btn btn-secondary btn-sm" onclick="uploadNewsThumb(' + i + ')">Naloži thumbnail</button>' +
        '<div class="field"><label>YouTube ID (opcijsko)</label><input data-news-yt="' + i + '" value="' + esc(item.youtube || '') + '" /></div>' +
        '<div class="field"><label>Video URL (opcijsko)</label><input data-news-video="' + i + '" value="' + esc(item.video || '') + '" /></div>' +
        '<div class="field"><label>Slike (URL-ji, vsak v svoji vrstici)</label><textarea data-news-images="' + i + '">' + esc((item.images||[]).join('\n')) + '</textarea></div>' +
        '</div>';
    }).join('') +
    '<button class="btn btn-secondary btn-sm" onclick="addNewsItem()">+ Dodaj novico</button>' +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'news\')">Shrani</button></div>';
}

function addNewsItem() {
  sectionData['news'].items.unshift({id:'nova-'+Date.now(),date:new Date().toISOString().slice(0,10),title:'',description:'',thumbnail:'',type:'novica'});
  renderSection('news');
}
function removeNewsItem(i) { sectionData['news'].items.splice(i,1); renderSection('news'); }
function uploadNewsThumb(i) {
  uploadImage(function(url) {
    var inp = document.querySelector('[data-news-thumb="' + i + '"]');
    if (inp) inp.value = url;
  }, CLOUDINARY_PRESETS.news);
}

function renderContact(el, d) {
  el.innerHTML = '<h2>Kontakt</h2>' +
    field('Oznaka sekcije', 'text', 'contact-sectionLabel', d.sectionLabel) +
    field('Naslov (besede, ločene z vejico)', 'text', 'contact-title', d.title.join(', ')) +
    field('Podnaslov', 'text', 'contact-subtitle', d.subtitle) +
    field('Email', 'email', 'contact-email', d.email) +
    '<h3 style="margin-top:1rem;margin-bottom:0.5rem">Socialna omrežja</h3>' +
    d.socialLinks.map(function(s, i) {
      return '<div class="card"><div class="card-header"><h3>' + esc(s.name) + '</h3><button class="btn btn-danger btn-sm" onclick="removeSocial(' + i + ')">Odstrani</button></div>' +
        '<div class="field"><label>Ime</label><input data-social-name="' + i + '" value="' + esc(s.name) + '" /></div>' +
        '<div class="field"><label>URL</label><input data-social-url="' + i + '" value="' + esc(s.url) + '" /></div></div>';
    }).join('') +
    '<button class="btn btn-secondary btn-sm" onclick="addSocial()">+ Dodaj omrežje</button>' +
    '<div class="actions"><button class="btn btn-primary" onclick="saveSection(\'contact\')">Shrani</button></div>';
}

function addSocial() { sectionData['contact'].socialLinks.push({name:'',url:''}); renderSection('contact'); }
function removeSocial(i) { sectionData['contact'].socialLinks.splice(i,1); renderSection('contact'); }

// --- Collect Form Data ---
function collectFormData(section) {
  switch(section) {
    case 'hero': return {
      title: val('hero-title'), subtitle: val('hero-subtitle'), tagline: val('hero-tagline'),
      image: val('hero-image'), imageAlt: val('hero-imageAlt'),
      buttons: Array.from(document.querySelectorAll('[data-btn-text]')).map(function(el, i) {
        return { text: el.value, link: document.querySelector('[data-btn-link="'+i+'"]').value, style: i===0?'primary':'secondary' };
      })
    };
    case 'about': return {
      sectionLabel: val('about-sectionLabel'), title: val('about-title').split(',').map(function(s){return s.trim();}),
      image: val('about-image'), imageAlt: val('about-imageAlt'),
      paragraphs: Array.from(document.querySelectorAll('[data-para]')).map(function(el){return el.value;}),
      ctaText: val('about-ctaText'), ctaLink: val('about-ctaLink')
    };
    case 'ponudba': return {
      sectionLabel: val('ponudba-sectionLabel'), title: val('ponudba-title').split(',').map(function(s){return s.trim();}),
      paragraphs: Array.from(document.querySelectorAll('[data-ponudba-para]')).map(function(el){return el.value;}),
      image: val('ponudba-image'), imageAlt: val('ponudba-imageAlt'),
      ctaText: val('ponudba-ctaText'), ctaLink: val('ponudba-ctaLink')
    };
    case 'videos': return {
      sectionLabel: val('videos-sectionLabel'), title: val('videos-title').split(',').map(function(s){return s.trim();}),
      videos: Array.from(document.querySelectorAll('[data-vid-id]')).map(function(el, i) {
        return { id: el.value, title: document.querySelector('[data-vid-title="'+i+'"]').value };
      })
    };
    case 'gallery': return {
      images: Array.from(document.querySelectorAll('[data-gal-src]')).map(function(el, i) {
        return { src: el.value, alt: document.querySelector('[data-gal-alt="'+i+'"]').value };
      })
    };
    case 'news': return {
      items: Array.from(document.querySelectorAll('[data-news-id]')).map(function(el, i) {
        var imgs = document.querySelector('[data-news-images="'+i+'"]').value.trim();
        var yt = document.querySelector('[data-news-yt="'+i+'"]').value.trim();
        var vid = document.querySelector('[data-news-video="'+i+'"]').value.trim();
        var ft = document.querySelector('[data-news-fulltext="'+i+'"]').value.trim();
        var obj = {
          id: el.value,
          date: document.querySelector('[data-news-date="'+i+'"]').value,
          title: document.querySelector('[data-news-title="'+i+'"]').value,
          description: document.querySelector('[data-news-desc="'+i+'"]').value,
          thumbnail: document.querySelector('[data-news-thumb="'+i+'"]').value,
          type: document.querySelector('[data-news-type="'+i+'"]').value
        };
        if (ft) obj.fullText = ft;
        if (yt) obj.youtube = yt;
        if (vid) obj.video = vid;
        if (imgs) obj.images = imgs.split('\n').map(function(s){return s.trim();}).filter(Boolean);
        return obj;
      })
    };
    case 'contact': return {
      sectionLabel: val('contact-sectionLabel'), title: val('contact-title').split(',').map(function(s){return s.trim();}),
      subtitle: val('contact-subtitle'), email: val('contact-email'),
      socialLinks: Array.from(document.querySelectorAll('[data-social-name]')).map(function(el, i) {
        return { name: el.value, url: document.querySelector('[data-social-url="'+i+'"]').value };
      })
    };
  }
}

// --- Helpers ---
function field(label, type, id, value) {
  if (type === 'textarea') {
    return '<div class="field"><label>' + label + '</label><textarea id="' + id + '">' + esc(value||'') + '</textarea></div>';
  }
  return '<div class="field"><label>' + label + '</label><input type="' + type + '" id="' + id + '" value="' + esc(value||'') + '" /></div>';
}

function val(id) { var el = document.getElementById(id); return el ? el.value : ''; }

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// --- Init ---
if (token) { showApp(); }
</script>
</body>
</html>
