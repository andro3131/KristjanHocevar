---
import { loadContent, formatDate } from "../utils/content";
import type { NewsContent } from "../types/content";

const news = loadContent<NewsContent>("news");
const allNewsItems = news.items;
const latestNews = allNewsItems.slice(0, 5);
---

<section id="novice" class="py-24 md:py-32 bg-surface">
  <div class="max-w-7xl mx-auto px-6">
    <!-- Naslov -->
    <div class="text-center mb-16 fade-in">
      <p class="text-accent tracking-[0.3em] uppercase text-sm mb-3 font-semibold">
        Novice
      </p>
      <h2 class="reveal-text font-serif text-4xl md:text-5xl font-bold" data-reveal>
        <span class="word"><span class="word-inner">Utrinki</span></span>
      </h2>
    </div>

    <!-- Timeline -->
    <div class="relative">
      <!-- Vertikalna črta - mobilno levo -->
      <div class="absolute left-4 top-0 bottom-0 w-px bg-accent/20 md:hidden"></div>
      <!-- Vertikalna črta - desktop sredina -->
      <div class="absolute left-1/2 top-0 bottom-0 w-px bg-accent/20 -translate-x-1/2 hidden md:block"></div>

      <div class="space-y-10 md:space-y-0">
        {
          latestNews.map((item, i) => {
            const isRight = i % 2 !== 0;
            return (
              <div class={`fade-in relative ${i > 0 ? "md:mt-6" : ""}`}>
                <!-- Pika - mobilno -->
                <div
                  class={`absolute left-4 top-1 w-2.5 h-2.5 rounded-full -translate-x-1/2 md:hidden ${
                    item.upcoming
                      ? "bg-accent shadow-[0_0_8px_rgba(200,149,60,0.5)]"
                      : "bg-muted/50"
                  }`}
                />
                <!-- Pika - desktop -->
                <div
                  class={`absolute left-1/2 top-6 w-3 h-3 rounded-full -translate-x-1/2 hidden md:block ${
                    item.upcoming
                      ? "bg-accent shadow-[0_0_8px_rgba(200,149,60,0.5)]"
                      : "bg-muted/50"
                  }`}
                />

                <!-- Kartica -->
                <div class={`pl-12 md:pl-0 md:w-[48%] ${isRight ? "md:ml-[51%]" : "md:ml-[1%]"}`}>
                  <div
                    class={`news-card group rounded-sm border cursor-pointer transition-all duration-300 overflow-hidden flex flex-col md:flex-row ${
                      item.upcoming
                        ? "bg-accent/5 border-accent/30 hover:border-accent/50"
                        : "bg-bg/50 border-text/5 hover:border-text/15"
                    }`}
                    data-news-trigger
                    data-news-id={item.id}
                  >
                    <!-- Slika -->
                    <div class="md:w-2/5 flex-shrink-0 overflow-hidden">
                      <img
                        src={item.thumbnail}
                        alt={item.title}
                        class="w-full h-full object-cover aspect-[16/10] md:aspect-auto md:min-h-full transition-transform duration-500 group-hover:scale-105"
                        loading="lazy"
                      />
                    </div>

                    <!-- Vsebina -->
                    <div class="p-4 md:p-5 flex flex-col justify-center flex-1 min-w-0">
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <time class="text-xs text-muted">{formatDate(item.date)}</time>
                        <span
                          class={`text-xs tracking-wider uppercase px-1.5 py-0.5 rounded-sm ${
                            item.type === "nastop"
                              ? "bg-primary/30 text-secondary"
                              : "bg-accent/10 text-accent"
                          }`}
                        >
                          {item.type}
                        </span>
                        {item.upcoming && (
                          <span class="text-xs tracking-wider uppercase text-accent font-semibold">
                            Prihajajoče
                          </span>
                        )}
                      </div>
                      <h3
                        class={`font-serif text-lg md:text-xl font-bold ${
                          item.upcoming ? "text-accent" : "text-text"
                        }`}
                      >
                        {item.title}
                      </h3>
                      <p class="text-muted text-sm mt-1 line-clamp-2">{item.description}</p>
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        }
      </div>
    </div>

    <!-- Poglej vse -->
    {allNewsItems.length > 5 && (
      <div class="text-center mt-12 fade-in">
        <a
          href="/novice"
          class="btn-fill inline-flex items-center gap-2 px-8 py-3 border border-text/30 text-text font-semibold tracking-wider uppercase text-sm rounded-sm"
        >
          Poglej vse novice
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>
    )}
  </div>
</section>

<!-- Modal -->
<div
  id="news-modal"
  class="fixed inset-0 z-[100] pointer-events-none opacity-0 transition-opacity duration-300"
>
  <div id="news-modal-backdrop" class="absolute inset-0 bg-bg/90 backdrop-blur-sm"></div>
  <div class="absolute inset-0 overflow-y-auto">
    <div class="min-h-full flex items-start justify-center py-12 px-4 md:px-8">
      <div
        id="news-modal-content"
        class="relative w-full max-w-2xl bg-surface border border-text/10 rounded-sm shadow-2xl transform translate-y-8 transition-transform duration-300"
      >
        <button
          id="news-modal-close"
          class="absolute top-4 right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-bg/50 text-text/70 hover:text-text hover:bg-bg/80 transition-colors"
          aria-label="Zapri"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <div id="news-modal-hero" class="w-full rounded-t-sm overflow-hidden bg-bg">
          <div id="news-modal-image" class="w-full overflow-hidden">
            <img src="" alt="" class="w-full max-h-[500px] object-contain transition-opacity duration-300" />
          </div>
          <div id="news-modal-youtube" class="w-full aspect-video hidden">
            <iframe class="w-full h-full" src="" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
          <div id="news-modal-video" class="w-full hidden">
            <video class="w-full max-h-[500px] object-contain" controls playsinline preload="metadata">
              <source src="" type="video/mp4" />
            </video>
          </div>
        </div>
        <div class="p-6 md:p-8">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <time id="news-modal-date" class="text-sm text-muted"></time>
            <span id="news-modal-type" class="text-xs tracking-wider uppercase px-2 py-0.5 rounded-sm"></span>
          </div>
          <h3 id="news-modal-title" class="font-serif text-2xl md:text-3xl font-bold mb-4"></h3>
          <p id="news-modal-text" class="text-muted leading-relaxed"></p>
          <div id="news-modal-gallery" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 hidden"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ newsItems: allNewsItems }}>
  function fmtDate(dateStr) {
    var d = new Date(dateStr);
    return d.toLocaleDateString("sl-SI", { day: "numeric", month: "long", year: "numeric" });
  }

  var modal = document.getElementById("news-modal");
  var modalBackdrop = document.getElementById("news-modal-backdrop");
  var modalContent = document.getElementById("news-modal-content");
  var modalClose = document.getElementById("news-modal-close");
  var modalImageWrap = document.getElementById("news-modal-image");
  var modalImage = modalImageWrap.querySelector("img");
  var modalYoutubeWrap = document.getElementById("news-modal-youtube");
  var modalYoutubeIframe = modalYoutubeWrap.querySelector("iframe");
  var modalVideoWrap = document.getElementById("news-modal-video");
  var modalVideo = modalVideoWrap.querySelector("video");
  var modalVideoSource = modalVideo.querySelector("source");
  var modalDate = document.getElementById("news-modal-date");
  var modalType = document.getElementById("news-modal-type");
  var modalTitle = document.getElementById("news-modal-title");
  var modalText = document.getElementById("news-modal-text");
  var modalGallery = document.getElementById("news-modal-gallery");

  function openModal(newsId) {
    var item = newsItems.find(function(n) { return n.id === newsId; });
    if (!item) return;

    modalImageWrap.classList.add("hidden");
    modalYoutubeWrap.classList.add("hidden");
    modalVideoWrap.classList.add("hidden");
    modalYoutubeIframe.src = "";
    modalVideo.pause();
    modalVideoSource.src = "";

    if (item.youtube) {
      modalYoutubeWrap.classList.remove("hidden");
      modalYoutubeIframe.src = "https://www.youtube-nocookie.com/embed/" + item.youtube;
      modalYoutubeIframe.title = item.title;
    } else if (item.video) {
      modalVideoWrap.classList.remove("hidden");
      modalVideoSource.src = item.video;
      modalVideo.load();
    } else {
      modalImageWrap.classList.remove("hidden");
      modalImage.src = (item.images && item.images[0]) || item.thumbnail;
      modalImage.alt = item.title;
    }

    modalDate.textContent = fmtDate(item.date);
    modalTitle.textContent = item.title;
    modalText.textContent = item.fullText || item.description;

    modalType.textContent = item.type;
    modalType.className = "text-xs tracking-wider uppercase px-2 py-0.5 rounded-sm " +
      (item.type === "nastop" ? "bg-primary/30 text-secondary" : "bg-accent/10 text-accent");

    if (item.images && item.images.length > 1) {
      modalGallery.innerHTML = item.images.map(function(img, i) {
        return '<div class="rounded-sm overflow-hidden cursor-pointer group/img" data-gallery-img="' + img + '">' +
          '<img src="' + img + '" alt="' + item.title + '" class="w-full h-48 object-cover transition-all duration-300 group-hover/img:scale-105 group-hover/img:brightness-110 ' + (i === 0 ? 'ring-2 ring-accent' : '') + '" loading="lazy" />' +
          '</div>';
      }).join("");
      modalGallery.classList.remove("hidden");

      modalGallery.querySelectorAll("[data-gallery-img]").forEach(function(el) {
        el.addEventListener("click", function(e) {
          e.stopPropagation();
          modalImage.src = el.dataset.galleryImg;
          modalGallery.querySelectorAll("img").forEach(function(img) {
            img.classList.remove("ring-2", "ring-accent");
          });
          el.querySelector("img").classList.add("ring-2", "ring-accent");
        });
      });
    } else {
      modalGallery.innerHTML = "";
      modalGallery.classList.add("hidden");
    }

    modal.classList.remove("pointer-events-none", "opacity-0");
    modal.classList.add("pointer-events-auto", "opacity-100");
    modalContent.classList.remove("translate-y-8");
    modalContent.classList.add("translate-y-0");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    modal.classList.add("opacity-0");
    modal.classList.remove("opacity-100");
    modalContent.classList.add("translate-y-8");
    modalContent.classList.remove("translate-y-0");
    document.body.style.overflow = "";
    modalYoutubeIframe.src = "";
    modalVideo.pause();
    setTimeout(function() {
      modal.classList.add("pointer-events-none");
      modal.classList.remove("pointer-events-auto");
    }, 300);
  }

  document.querySelectorAll("[data-news-trigger]").forEach(function(trigger) {
    trigger.addEventListener("click", function() {
      var id = trigger.dataset.newsId;
      if (id) openModal(id);
    });
  });

  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", closeModal);
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") closeModal();
  });
</script>
