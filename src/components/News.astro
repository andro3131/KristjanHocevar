---
import { allNews, formatDate } from "../data/news";

const latestNews = allNews.slice(0, 5);
---

<section id="novice" class="py-24 md:py-32 bg-surface">
  <div class="max-w-5xl mx-auto px-6">
    <!-- Naslov -->
    <div class="text-center mb-16 fade-in">
      <p class="text-accent tracking-[0.3em] uppercase text-sm mb-3 font-semibold">
        Novice
      </p>
      <h2 class="reveal-text font-serif text-4xl md:text-5xl font-bold" data-reveal>
        <span class="word"><span class="word-inner">Kaj</span></span>
        <span class="word"><span class="word-inner" style="transition-delay: 0.1s">se</span></span>
        <span class="word"><span class="word-inner" style="transition-delay: 0.2s">dogaja</span></span>
      </h2>
    </div>

    <!-- Timeline -->
    <div class="relative">
      <!-- Vertikalna 훾rta - mobilno levo -->
      <div class="absolute left-4 top-0 bottom-0 w-px bg-accent/20 md:hidden"></div>
      <!-- Vertikalna 훾rta - desktop sredina -->
      <div class="absolute left-1/2 top-0 bottom-0 w-px bg-accent/20 -translate-x-1/2 hidden md:block"></div>

      <div class="space-y-10 md:space-y-0">
        {
          latestNews.map((item, i) => {
            const isRight = i % 2 !== 0;
            return (
              <div class={`fade-in relative ${i > 0 ? "md:-mt-36" : ""}`}>
                <!-- Pika - mobilno -->
                <div
                  class={`absolute left-4 top-1 w-2.5 h-2.5 rounded-full -translate-x-1/2 md:hidden ${
                    item.upcoming
                      ? "bg-accent shadow-[0_0_8px_rgba(200,149,60,0.5)]"
                      : "bg-muted/50"
                  }`}
                />
                <!-- Pika - desktop -->
                <div
                  class={`absolute left-1/2 top-6 w-3 h-3 rounded-full -translate-x-1/2 hidden md:block ${
                    item.upcoming
                      ? "bg-accent shadow-[0_0_8px_rgba(200,149,60,0.5)]"
                      : "bg-muted/50"
                  }`}
                />

                <!-- Kartica -->
                <div class={`pl-12 md:pl-0 md:w-[calc(50%-1.5rem)] ${isRight ? "md:ml-auto" : ""}`}>
                  <div
                    class={`news-card group rounded-sm border cursor-pointer transition-all duration-300 overflow-hidden ${
                      item.upcoming
                        ? "bg-accent/5 border-accent/30 hover:border-accent/50"
                        : "bg-bg/50 border-text/5 hover:border-text/15"
                    }`}
                    data-news-trigger
                    data-news-id={item.id}
                  >
                    <!-- Slika -->
                    <div class="aspect-[16/10] overflow-hidden">
                      <img
                        src={item.thumbnail}
                        alt={item.title}
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                        loading="lazy"
                      />
                    </div>

                    <!-- Vsebina -->
                    <div class="p-4">
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <time class="text-xs text-muted">{formatDate(item.date)}</time>
                        <span
                          class={`text-xs tracking-wider uppercase px-1.5 py-0.5 rounded-sm ${
                            item.type === "nastop"
                              ? "bg-primary/30 text-secondary"
                              : "bg-accent/10 text-accent"
                          }`}
                        >
                          {item.type}
                        </span>
                        {item.upcoming && (
                          <span class="text-xs tracking-wider uppercase text-accent font-semibold">
                            Prihajajo훾e
                          </span>
                        )}
                      </div>
                      <h3
                        class={`font-serif text-lg md:text-xl font-bold ${
                          item.upcoming ? "text-accent" : "text-text"
                        }`}
                      >
                        {item.title}
                      </h3>
                      <p class="text-muted text-sm mt-1 line-clamp-2">{item.description}</p>
                    </div>
                  </div>
                </div>
              </div>
            );
          })
        }
      </div>
    </div>

    <!-- Poglej vse -->
    {allNews.length > 5 && (
      <div class="text-center mt-12 fade-in">
        <a
          href="/novice"
          class="btn-fill inline-flex items-center gap-2 px-8 py-3 border border-text/30 text-text font-semibold tracking-wider uppercase text-sm rounded-sm"
        >
          Poglej vse novice
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </a>
      </div>
    )}
  </div>
</section>

<!-- Modal -->
<div
  id="news-modal"
  class="fixed inset-0 z-[100] pointer-events-none opacity-0 transition-opacity duration-300"
>
  <!-- Ozadje -->
  <div id="news-modal-backdrop" class="absolute inset-0 bg-bg/90 backdrop-blur-sm"></div>

  <!-- Vsebina -->
  <div class="absolute inset-0 overflow-y-auto">
    <div class="min-h-full flex items-start justify-center py-12 px-4 md:px-8">
      <div
        id="news-modal-content"
        class="relative w-full max-w-2xl bg-surface border border-text/10 rounded-sm shadow-2xl transform translate-y-8 transition-transform duration-300"
      >
        <!-- Zapri gumb -->
        <button
          id="news-modal-close"
          class="absolute top-4 right-4 z-10 w-10 h-10 flex items-center justify-center rounded-full bg-bg/50 text-text/70 hover:text-text hover:bg-bg/80 transition-colors"
          aria-label="Zapri"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <!-- Slika ali YouTube -->
        <div id="news-modal-hero" class="w-full rounded-t-sm overflow-hidden bg-bg">
          <div id="news-modal-image" class="w-full overflow-hidden">
            <img src="" alt="" class="w-full max-h-[500px] object-contain transition-opacity duration-300" />
          </div>
          <div id="news-modal-youtube" class="w-full aspect-video hidden">
            <iframe
              class="w-full h-full"
              src=""
              title=""
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>
          <div id="news-modal-video" class="w-full hidden">
            <video
              class="w-full max-h-[500px] object-contain"
              controls
              playsinline
              preload="metadata"
            >
              <source src="" type="video/mp4" />
            </video>
          </div>
        </div>

        <!-- Besedilo -->
        <div class="p-6 md:p-8">
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <time id="news-modal-date" class="text-sm text-muted"></time>
            <span id="news-modal-type" class="text-xs tracking-wider uppercase px-2 py-0.5 rounded-sm"></span>
          </div>
          <h3 id="news-modal-title" class="font-serif text-2xl md:text-3xl font-bold mb-4"></h3>
          <p id="news-modal-text" class="text-muted leading-relaxed"></p>

          <!-- Galerija slik -->
          <div id="news-modal-gallery" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3 hidden">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { allNews, formatDate } from "../data/news";

  const modal = document.getElementById("news-modal")!;
  const modalBackdrop = document.getElementById("news-modal-backdrop")!;
  const modalContent = document.getElementById("news-modal-content")!;
  const modalClose = document.getElementById("news-modal-close")!;
  const modalImageWrap = document.getElementById("news-modal-image")!;
  const modalImage = modalImageWrap.querySelector("img") as HTMLImageElement;
  const modalYoutubeWrap = document.getElementById("news-modal-youtube")!;
  const modalYoutubeIframe = modalYoutubeWrap.querySelector("iframe") as HTMLIFrameElement;
  const modalVideoWrap = document.getElementById("news-modal-video")!;
  const modalVideo = modalVideoWrap.querySelector("video") as HTMLVideoElement;
  const modalVideoSource = modalVideo.querySelector("source") as HTMLSourceElement;
  const modalDate = document.getElementById("news-modal-date")!;
  const modalType = document.getElementById("news-modal-type")!;
  const modalTitle = document.getElementById("news-modal-title")!;
  const modalText = document.getElementById("news-modal-text")!;
  const modalGallery = document.getElementById("news-modal-gallery")!;

  function openModal(newsId: string) {
    const item = allNews.find((n) => n.id === newsId);
    if (!item) return;

    // Skrij vse hero elemente
    modalImageWrap.classList.add("hidden");
    modalYoutubeWrap.classList.add("hidden");
    modalVideoWrap.classList.add("hidden");
    modalYoutubeIframe.src = "";
    modalVideo.pause();
    modalVideoSource.src = "";

    if (item.youtube) {
      modalYoutubeWrap.classList.remove("hidden");
      modalYoutubeIframe.src = `https://www.youtube-nocookie.com/embed/${item.youtube}`;
      modalYoutubeIframe.title = item.title;
    } else if (item.video) {
      modalVideoWrap.classList.remove("hidden");
      modalVideoSource.src = item.video;
      modalVideo.load();
    } else {
      modalImageWrap.classList.remove("hidden");
      modalImage.src = item.images?.[0] || item.thumbnail;
      modalImage.alt = item.title;
    }

    modalDate.textContent = formatDate(item.date);
    modalTitle.textContent = item.title;
    modalText.textContent = item.fullText || item.description;

    // Tip badge
    modalType.textContent = item.type;
    modalType.className = `text-xs tracking-wider uppercase px-2 py-0.5 rounded-sm ${
      item.type === "nastop"
        ? "bg-primary/30 text-secondary"
        : "bg-accent/10 text-accent"
    }`;

    // Galerija - vse slike kot klikljivi thumbnailsi
    if (item.images && item.images.length > 1) {
      modalGallery.innerHTML = item.images
        .map(
          (img, i) =>
            `<div class="rounded-sm overflow-hidden cursor-pointer group/img" data-gallery-img="${img}">
              <img src="${img}" alt="${item.title}" class="w-full h-48 object-cover transition-all duration-300 group-hover/img:scale-105 group-hover/img:brightness-110 ${i === 0 ? 'ring-2 ring-accent' : ''}" loading="lazy" />
            </div>`
        )
        .join("");
      modalGallery.classList.remove("hidden");

      // Klik na galerijske slike
      modalGallery.querySelectorAll("[data-gallery-img]").forEach((el) => {
        el.addEventListener("click", (e) => {
          e.stopPropagation();
          const src = (el as HTMLElement).dataset.galleryImg!;
          modalImage.src = src;
          // Posodobi ring na aktivni sliki
          modalGallery.querySelectorAll("img").forEach((img) => {
            img.classList.remove("ring-2", "ring-accent");
          });
          (el.querySelector("img") as HTMLElement).classList.add("ring-2", "ring-accent");
        });
      });
    } else {
      modalGallery.innerHTML = "";
      modalGallery.classList.add("hidden");
    }

    // Prika탑i modal
    modal.classList.remove("pointer-events-none", "opacity-0");
    modal.classList.add("pointer-events-auto", "opacity-100");
    modalContent.classList.remove("translate-y-8");
    modalContent.classList.add("translate-y-0");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    modal.classList.add("opacity-0");
    modal.classList.remove("opacity-100");
    modalContent.classList.add("translate-y-8");
    modalContent.classList.remove("translate-y-0");
    document.body.style.overflow = "";
    // Ustavi medije
    modalYoutubeIframe.src = "";
    modalVideo.pause();
    setTimeout(() => {
      modal.classList.add("pointer-events-none");
      modal.classList.remove("pointer-events-auto");
    }, 300);
  }

  // Klik na novico
  document.querySelectorAll("[data-news-trigger]").forEach((trigger) => {
    trigger.addEventListener("click", () => {
      const id = (trigger as HTMLElement).dataset.newsId;
      if (id) openModal(id);
    });
  });

  // Zapri modal
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", closeModal);

  // Escape tipka
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });
</script>
